name: Continuous Deployment

# ⭐⭐ THIS IS THE CONNECTION POINT ⭐⭐
on:
  # Trigger WHEN CI pipeline completes SUCCESSFULLY
  workflow_run:
    workflows: ["Continuous Integration"]  # Name of CI workflow
    branches: [main, release/*]           # Only for these branches
    types: [completed]                    # When CI finishes

jobs:
  deploy-to-nexus:
    # ⭐⭐ CRITICAL: Only run if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download artifact from CI
      uses: actions/download-artifact@v3
      with:
        name: application-jar
        # This downloads from the CI workflow run
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
    
    - name: Deploy to Nexus
      env:
        NEXUS_URL: ${{ secrets.NEXUS_URL }}
        NEXUS_USER: ${{ secrets.NEXUS_USERNAME }}
        NEXUS_PASS: ${{ secrets.NEXUS_PASSWORD }}
      run: |
        echo "Deploying version from CI workflow..."
        
        # Create Maven settings with CI credentials
        cat > settings.xml << EOF
        <settings>
          <servers>
            <server>
              <id>nexus-snapshots</id>
              <username>$NEXUS_USER</username>
              <password>$NEXUS_PASS</password>
            </server>
            <server>
              <id>nexus-releases</id>
              <username>$NEXUS_USER</username>
              <password>$NEXUS_PASS</password>
            </server>
          </servers>
        </settings>
        EOF
        
        # Determine if snapshot or release
        if [[ "${{ github.event.workflow_run.head_branch }}" == "main" ]]; then
          echo "Deploying RELEASE to Nexus"
          mvn deploy -DskipTests -s settings.xml
        else
          echo "Deploying SNAPSHOT to Nexus"
          mvn deploy -DskipTests -s settings.xml
        fi
    
    - name: Verify Deployment
      run: |
        echo "✅ CI Workflow: ${{ github.event.workflow_run.name }}"
        echo "✅ Triggered by: ${{ github.event.workflow_run.head_branch }}"
        echo "✅ Status: ${{ github.event.workflow_run.conclusion }}"
        echo "✅ Artifact deployed to Nexus!"